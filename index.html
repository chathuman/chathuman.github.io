<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="description" content="ChatHuman: Language-driven 3D Human Understanding with Retrieval-Augmented Tool Reasoning">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ChatHuman</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E0HR9YQK2K"></script>
    <script>
      window.dataLayer = window.datxaLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-E0HR9YQK2K');
    </script>
    
    <script>
    function updateInteractive() {
        var task = document.getElementById("interative-menu").value;
  
        console.log("interactive", task)
  
        // if task does not contain the string "towel"
        if (task.indexOf("towel") == -1) {
          var video = document.getElementById("interactive-video");
          video.src = "media/videos/" + 
                      task + 
                      ".mp4"
          video.play();
  
          var html = document.getElementById("interactive-html-1");
          html.src = "media/interactive/" + 
                      task + 
                      ".html"
  
          // hide the second iframe container
          var iframeContainer2 = document.getElementById("second-iframe-container");
          iframeContainer2.style.display = "none";
        } else {
          var video = document.getElementById("interactive-video");
          video.src = "media/videos/hang-towel.mp4"
          video.play();
  
          var html1 = document.getElementById("interactive-html-1");
          html1.src = "media/interactive/hang-towel-1.html"
  
          // show and set the source for the second iframe
          var html2 = document.getElementById("interactive-html-2");
          html2.src = "media/interactive/hang-towel-2.html"
  
          // show the second iframe container
          var iframeContainer2 = document.getElementById("second-iframe-container");
          iframeContainer2.style.display = "block";
        }
      }

    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet">

    <link rel="stylesheet" href="./static/css/bulma.min.css">
    <link rel="stylesheet" href="./static/css/bulma-carousel.min.css">
    <link rel="stylesheet" href="./static/css/bulma-slider.min.css">
    <link rel="stylesheet" href="./static/css/fontawesome.all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
    <link rel="stylesheet" href="./static/css/index.css">

    <style>
		.render_wrapper {
			position: relative;
            height: 300px;
         }
        .render_wrapper_small {
			position: relative;
            height: 200px;
         }
		.render_div {
			position: absolute;
			top: 0;
			left: 0;
		}

        #interpolation-image-wrapper-car{
            text-align: center;
        }
        #interpolation-image-wrapper-chair{
            text-align: center;
        }
        .nested-columns {
            margin-bottom: 0 !important;
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script defer src="./static/js/fontawesome.all.min.js"></script>
    <script src="./static/js/bulma-carousel.min.js"></script>
    <script src="./static/js/bulma-slider.min.js"></script>
    <script src="https://unpkg.com/interactjs/dist/interact.min.js"></script>
    <script src="./static/js/index.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
    <script type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
</head>

<body>

    <section class="hero">
        <div class="hero-body">
          <div class="container is-fullhd">
            <div class="columns is-centered">
              <div class="column has-text-centered">
                <h1 class="title is-1 publication-title">ChatHuman: Language-driven 3D Human Understanding </br> with Retrieval-Augmented Tool Reasoning</h1>
                <div class="is-size-5 publication-authors">
                  <span class="author-block">
                    <a target="_blank" href="https://jinglin7.github.io/">Jing Lin</a><sup>3,4</sup>,
                  </span>
                  <span class="author-block">
                    <a target="_blank" href="https://scholar.google.com/citations?user=wNQQhSIAAAAJ&hl=en">Yao Feng</a><sup>1,2,3</sup>,
                  </span>
                  <span class="author-block">
                    <a target="_blank" href="https://wyliu.com/">Weiyang Liu</a><sup>1,5</sup>,
                  </span>
                  <span class="author-block">
                    <a target="_blank" href="https://ps.is.mpg.de/person/black">Michael J. Black</a><sup>3</sup>,
                  </span>
                </div>
      
                <div class="is-size-5 publication-authors">
                  <span class="author-block"><sup>1</sup>Max Planck Institute for Intelligent Systems,</span> 
                  <span class="author-block"><sup>2</sup>ETH ZÃ¼rich,</span> </br>
                  <span class="author-block"><sup>3</sup>Meshcapade,</span>
                  <span class="author-block"><sup>4</sup>Tsinghua University,</span>
                  <span class="author-block"><sup>5</sup>University of Cambridge</span>
                </div>
      
                <div class="column has-text-centered">
                  <div class="publication-links">
                    <!-- PDF Link. -->
                    <span class="link-block">
                      <a target="_blank" href="static/ChatHuman.pdf"
                         class="external-link button is-normal is-rounded is-dark">
                        <span class="icon">
                            <i class="fas fa-file-pdf"></i>
                        </span>
                        <span>Paper</span>
                      </a>
                    </span>
                    
                    <!-- Gradio Demo Link. -->
                    <span class="link-block">
                        <a href="https://89a83eced7a6ea7fa574bf601bda74c1.serveo.net/" target="_blank"
                           class="external-link button is-normal is-rounded is-dark">
                        <span class="icon">
                          ðŸ¤—
                        </span>
                        <span>Demo</span>
                      </a>
                    </span>
      
                  <!-- Arxiv Link. -->
                  <span class="link-block">
                    <a target="_blank" href="chathuman.github.io"
                       class="external-link button is-normal is-rounded is-dark">
                      <span class="icon">
                          <i class="fas fa-file"></i>
                      </span>
                      <span>ArXiv</span>
                    </a>
                  </span>
      
                  <!-- Video Link. -->
                  <span class="link-block">
                    <a target="_blank" href="chathuman.github.io"
                       class="external-link button is-normal is-rounded is-dark">
                      <span class="icon">
                          <i class="fab fa-youtube"></i>
                      </span>
                      <span>Video</span>
                    </a>
                  </span>
      
                  <!-- Code Link. -->
                  <span class="link-block">
                    <a target="_blank" href="chathuman.github.io"
                       class="external-link button is-normal is-rounded is-dark">
                      <span class="icon">
                          <i class="fab fa-github"></i>
                      </span>
                      <span>Code (Coming)</span>
                      </a>
                  </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

    <section class="hero teaser">
        <div class="container is-max-desktop">
            <div class="hero-body">
                <video id="teaser" autoplay muted loop width="100%">
                    <source src="media/videos/chathuman_shortvideo.mp4"
                            type="video/mp4">
                </video>
                <h2 class=" subtitle has-text-centered" style="padding-top: 10px">
                    <p align="left">
                        ChatHuman is a multi-modal LLM specialized for understanding humans and their 3D behavior with the assistance of 24 human-related tools.
                    </p>
                </h2>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container is-max-desktop">
            <!-- Abstract. -->
            <div class="columns is-centered has-text-centered">
                <div class="column is-four-fifths">
                    <h2 class="title is-3">Abstract</h2>
                    <div class="content has-text-justified">
                        <p margin="0">
                            Numerous methods have been proposed to detect, estimate, and analyze properties of people in images, including the estimation of 3D pose, shape, contact, human-object interaction, emotion, and more. Each of these methods works in isolation instead of synergistically. Here we address this problem and build a language-driven human understanding system that combines and integrates the skills of many different methods. To do so, we fine-tune a Large Language Model (LLM) to select and use a wide variety of existing tools in response to user inputs. In doing so, our ChatHuman is able to combine information from multiple tools to solve problems more accurately than the individual tools themselves and to leverage tool output to improve its ability to reason about humans. The novel features of ChatHuman include leveraging academic publications to guide the application of 3D human-related tools, employing a retrieval augmented generation model to generate in-context-learning examples for handling new tools, and discriminating and integrating tool results to enhance 3D human understanding. Extensive quantitative evaluation shows that ChatHuman outperforms existing models in both tool selection accuracy and performance across multiple 3D human-related tasks. ChatHuman is a step towards consolidating diverse methods for human analysis into a single, powerful, system for reasoning about people in 3D. 
                    </div>
                </div>
            </div>

            <!-- Paper video. -->
            <div class="columns">
                <div class="column has-text-centered">
                  <video id="dist1"
                    controls
                    muted
                    loop
                    width="99%">
                    <source src="media/videos/chathuman_longvideo.mp4" 
                    type="video/mp4">
                  </video>
                  <p style="text-align:center">
                  </p>
                </div>
            <!--/ Paper video. -->
        </div>
    </section>




    <section class="section">
        <div class="container is-max-desktop">

        <h2 class="title is-3">Real World Application</h2>

        <div class="columns">
            <div class="column has-text-centered">
  
              Gradio Interface demo for   
              <div class="select is-small is-rounded">     
                <select id="interative-menu" onchange="updateInteractive()">
                <option value="robotics_clip1" selected="selected">"Robotics-1"</option>
                <option value="robotics_clip2">"Robotics-2"</option>
                <option value="fitness_health_clip1">"Fitness & Health-1"</option>
                <option value="fitness_health_clip2">"Fitness & Health-2"</option>
                <option value="entertainment_gaming_clip1">"Entertainment & Gaming-1"</option>
                <option value="entertainment_gaming_clip2">"Entertainment & Gaming-2"</option>
                <option value="art_design_clip1">"Art & Design"</option>
                <option value="security_privacy_clip1">"Security & Privacy-1"</option>
                <option value="security_privacy_clip2">"Security & Privacy-2"</option>
                <option value="fashion_clip1">"Fashion"</option>
                </select>
              </div>
            </div>
  
          </div>
  
          <div class="columns">
            <div class="column has-text-centered">
              <p style="text-align:center;">
                <video id="interactive-video" width="100%" height="100%" controls autoplay loop muted>
                  <source src="media/videos/robotics_clip1.mp4" type="video/mp4">
                </video>
              </p>
            </div>
          </div>


            <!-- Overview. -->
            <div class="columns is-centered" style="margin-top: 15px">
                <div class="column is-full-width">
                    <h2 class="title is-4">Method Overview</h2>
                    <img src="media/figures/pipeline.png">
                    <div class="content has-text-justified" style="padding-top: 15px">
                        <p><b>1.</b> ChatHuman takes input text queries, images, or other 3D human-related modalities such as vectors like SMPL pose</p>
                        <p><b>2.</b> Then, based on the user query, ChatHuman adopts a paper-based retrieval-augmented generation mechanism to generate a textual response about the tool use and call the tools.</p>
                        <p><b>3.</b> Finally, the tool results are transformed into a textual or visual format and fed into the multimodal LLM-based agent, which will incorporate the tool results with its generic world knowledge to generate a response in the form of text, images, or other modalities related to 3D humans.</p>
                    </div>

                </div>
            </div>

        </div>
    </section>

    <section class="section" id="BibTeX">
        <div class="container is-max-desktop content">
            <h2 class="title">BibTeX</h2>
            <pre>
<code>
@inproceedings{jing2024chathuman,
 author={Jing Lin and Yao Feng and Weiyang Liu and Michael J. Black},
 title={{ChatHuman}: Language-driven {3D} Human Understanding with Retrieval-Augmented Tool Reasoning},
 journal={arXiv preprint arXiv:xxxx.xxxxx},
 year = {2024}}
</code></pre>
        </div>
    </section>


    <footer class="footer">
        <div class="container">
            <div class="content has-text-centered">
                <a class="icon-link" href="static/ChatHuman.pdf">
                    <i class="fas fa-file-pdf"></i>
                </a>
                <a class="icon-link" href="https://github.com/linjing7" class="external-link" disabled>
                    <i class="fab fa-github"></i>
                </a>
            </div>
            <div class="columns is-centered">
                <div class="column is-8">
                    <div class="content">
                        <p style="text-align:center">
                            Source code mainly borrowed from <a href="https://keunhong.com/">Keunhong Park</a>'s
                            <a href="https://nerfies.github.io/">Nerfies website</a> and
                            <a href="https://niessnerlab.org/members/simon_giebenhain/profile.html">Simon Giebenhain's</a> adoption for
                            <a href="https://simongiebenhain.github.io/NPHM/">NPHM</a>.
                        </p>
                        <p style="text-align:center">
                            Please contact <a href="https://jinglin7.github.io/">Jing Lin</a> for feedback and questions.
                        </p>

                    </div>
                </div>
            </div>
        </div>
    </footer>





    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "./js/three.module.js"
            }
        }
    </script>

    <script type="module">

        import * as THREE from 'three';

        import { PLYLoader } from './js/PLYLoader.js';
        import { OrbitControls } from './js/OrbitControls.js'
        let div_to_scene = {
            "mesh_chair_0": {
                "geo": null,
            },
            "mesh_chair_1": {
                "geo": null,
            },
            "mesh_chair_2": {
                "geo": null,
            },
            "mesh_chair_3": {
                "geo": null,
            },
            "mesh_car_0": {
                "geo": null,
            },
            "mesh_car_1": {
                "geo": null,
            },
            "mesh_car_2": {
                "geo": null,
            },
            "mesh_car_3": {
                "geo": null,
            }
        }
        let div_to_render_scene = {
            "mesh_style_0": {
                "0": null,
                "2": null,
                "3": null,
                "4": null,
                "5": null,
            },
            "mesh_style_1": {
                "0": null,
                "2": null,
                "3": null,
                "4": null,
                "5": null,
            },
            "mesh_style_2": {
                "0": null,
                "2": null,
                "3": null,
                "4": null,
                "5": null,

            },
            "mesh_style_3": {
                "0": null,
                "2": null,
                "3": null,
                "4": null,
                "5": null,
            },
        }
        let mouse_button_down = false;
        let list_of_orbit_controls = []
        let style_camera = null;
        let render_colors = true;
        let style_id = "0"

        function setup_camera(div_name){
            let container = document.getElementById(div_name);
            let width = container.parentElement.clientWidth;
            let height = container.parentElement.clientHeight;
            console.log(width, height)
            let camera = new THREE.PerspectiveCamera( 35, width / height, 0.1, 50 );
            //let camera_init_position = new THREE.Vector3( -1.5, 0.35, 1.2 );
            let camera_init_position = new THREE.Vector3( 0., 0., 1.2 );
            camera_init_position = camera_init_position.multiplyScalar(1.5)
            //if (div_name.includes("style")) {
            //    camera_init_position = camera_init_position.multiplyScalar(1.25)
            //}
            //else if (div_name.includes("style")) {
            //    camera_init_position = camera_init_position.multiplyScalar(1.25)
            //}
            camera.position.set(camera_init_position.x, camera_init_position.y, camera_init_position.z);
            return camera;
        }

        function setup_render_divs(div_name, mesh_path){
            let camera = setup_camera(div_name)
            let orbit_control = create_render_div(camera, div_name, mesh_path)
            list_of_orbit_controls.push(orbit_control)
        }

        function setup_style_render_divs(div_name, mesh_path){
            if (style_camera == null) {
                style_camera = setup_camera(div_name)
            }
            let orbit_control = create_style_render_div(style_camera, div_name, mesh_path, true)
            list_of_orbit_controls.push(orbit_control)
            document.getElementById("style_button_0").addEventListener("click", set_style_0)
            document.getElementById("style_button_2").addEventListener("click", set_style_2)
            document.getElementById("style_button_3").addEventListener("click", set_style_3)
            document.getElementById("style_button_4").addEventListener("click", set_style_4)
            document.getElementById("style_button_5").addEventListener("click", set_style_5)
        }

        function create_render_div(camera, div_id, mesh_path) {
            let container;
            let renderer, controls;

            init();
            animate();

            function init() {

                container = document.getElementById(div_id);
                let width = container.parentElement.clientWidth;
                let height = container.parentElement.clientHeight;


                div_to_scene[div_id]["geo"] = new THREE.Scene();
                div_to_scene[div_id]["geo"].background = new THREE.Color( 0xffffff );
                //var axesHelper = new THREE.AxesHelper( 5 );
                //div_to_scene[div_id]["geo"].add( axesHelper );

                // PLY file

                const loader = new PLYLoader();
                loader.load( mesh_path, function ( geometry ) {

                    geometry.computeVertexNormals();
                    //let material_geo = new THREE.MeshStandardMaterial( { color: 0x444444, flatShading: true, roughness: 0.5, metalness: 0.3 } )
                    //let material_geo = new THREE.MeshPhongMaterial( { color: 0x999999, depthWrite: false} )
                    const material_geo = new THREE.MeshPhongMaterial( {
                                                color: 0xCCE6FF,
                                                specular: 0x222222,
                                                shininess: 25,} );

                    const mesh_geo = new THREE.Mesh( geometry, material_geo );
                    //mesh_geo.castShadow = true;
				    //mesh_geo.receiveShadow = true;
                    div_to_scene[div_id]["geo"].add( mesh_geo );

                }, (xhr) => {
                    console.log((xhr.loaded / xhr.total) * 100 + '% loaded')
                }, (error) => {
                    console.log(error)
                }
                );

                // lights

                //div_to_scene[div_id]["geo"].add( new THREE.HemisphereLight( 0x333333, 0x222222) );
                //div_to_scene[div_id]["geo"].add(new THREE.AmbientLight( 0x333333, 1) );
                //const directionalLight = new THREE.DirectionalLight( 0xffffff, 1. );
                //directionalLight.position.set( 1, 1, 1 );
                //div_to_scene[div_id]["geo"].add( directionalLight );
                //addShadowedLight(div_to_scene[div_id]["geo"], -5, -5, 5, 0xffffff, 1. );
                //addShadowedLight(div_to_scene[div_id]["geo"], 1, 1, 1, 0xffffff, 1.35 );
                //addShadowedLight(div_to_scene[div_id]["geo"], -1, 1, -1, 0xffffff, 1.35 );
                //addShadowedLight(div_to_scene[div_id]["geo"], 0, -2, 1, 0xffffff, 0.5 );
                //addShadowedLight(div_to_scene[div_id]["geo"],  0, -1, 2, 0xffffff, 0.5 );

                add_lights(div_to_scene[div_id]["geo"])




                // renderer

                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( width, height);
                renderer.outputEncoding = THREE.sRGBEncoding;

                //renderer.shadowMap.enabled = true;

                container.appendChild( renderer.domElement );

                controls = new OrbitControls(camera, renderer.domElement)
                controls.enableDamping = false
                controls.autoRotate = true


                // resize

                window.addEventListener( 'resize', onWindowResize );
                //controls.addEventListener('change', onChange)
                controls.addEventListener('start', function(){
                  //clearTimeout(autorotateTimeout);
                  controls.autoRotate = false;
                });

                // restart autorotate after the last interaction & an idle time has passed
                //this.controls.addEventListener('end', function(){
                //  autorotateTimeout = setTimeout(function(){
                //    controls.autoRotate = true;
                //  }, 1000);
                //});

        }
            function onWindowResize() {
                let width = container.clientWidth;
                let height = container.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize( width, height );
            }
            function animate() {
                requestAnimationFrame( animate );
                controls.update();
                render();
            }

            function render() {
                renderer.render( div_to_scene[div_id]["geo"], camera );
                controls.update();
            }

            return controls;
        }

        function add_lights(scene) {
                scene.add( new THREE.HemisphereLight( 0x443333, 0x111122 ,0.05) );
				const spotLight = new THREE.SpotLight( 0xffffff, 0.5 );
				spotLight.position.set( 0.0, 0.5, 1 );
				const spotLight2 = new THREE.SpotLight( 0xffffff, 0.25 );
			    spotLight2.position.set( -2, 0.3, -0.2 );
				const spotLight3 = new THREE.SpotLight( 0xffffff, 0.25 );
				spotLight3.position.set( 2, -0.3, 0.2 );
				const spotLight4 = new THREE.SpotLight( 0xffffff, 0.25 );
				spotLight4.position.set( 0.0, 1, -2 );
				const spotLight5 = new THREE.SpotLight( 0xffffff, 0.05 );
				spotLight5.position.set( 0, -2.5, -1 );
				////spotLight.position.multiplyScalar( 700 );
				scene.add( spotLight );
				scene.add( spotLight2 );
				scene.add( spotLight3 );
				scene.add( spotLight4 );
				scene.add( spotLight5 );


        }

        function add_lightsBACKUP(scene) {
                scene.add( new THREE.HemisphereLight( 0x443333, 0x111122 ,0.05) );
				const spotLight = new THREE.SpotLight( 0xffffff, 0.6 );
				spotLight.position.set( 0.5, 0.5, 1 );
				const spotLight2 = new THREE.SpotLight( 0xffffff, 0.3 );
				spotLight2.position.set( -0.75, 0.2, 0 );
				const spotLight3 = new THREE.SpotLight( 0xffffff, 0.3 );
				spotLight3.position.set( -0.5, 0, 1 );
				const spotLight4 = new THREE.SpotLight( 0xffffff, 0.3 );
				spotLight4.position.set( 0.5, 0.5, -1 );
				const spotLight5 = new THREE.SpotLight( 0xffffff, 0.15 );
				spotLight5.position.set( 0, -1.5, 0 );
				////spotLight.position.multiplyScalar( 700 );
				scene.add( spotLight );
				scene.add( spotLight2 );
				//div_to_scene[div_id]["geo"].add( spotLight3 );
				scene.add( spotLight4 );
				scene.add( spotLight5 );
        }

        function create_style_render_div(camera, div_id, mesh_path) {
            let container;
            let renderer, controls;

            init();
            animate();

            function init() {

                container = document.getElementById(div_id);
                let width = container.parentElement.clientWidth;
                let height = container.parentElement.clientHeight;


                div_to_render_scene[div_id]["0"] = new THREE.Scene();
                div_to_render_scene[div_id]["1"] = new THREE.Scene();
                div_to_render_scene[div_id]["2"] = new THREE.Scene();
                div_to_render_scene[div_id]["3"] = new THREE.Scene();
                div_to_render_scene[div_id]["4"] = new THREE.Scene();
                div_to_render_scene[div_id]["5"] = new THREE.Scene();
                div_to_render_scene[div_id]["6"] = new THREE.Scene();
                div_to_render_scene[div_id]["0"].background = new THREE.Color( 0xffffff );
                div_to_render_scene[div_id]["1"].background = new THREE.Color( 0xffffff );
                div_to_render_scene[div_id]["2"].background = new THREE.Color( 0xffffff );
                div_to_render_scene[div_id]["3"].background = new THREE.Color( 0xffffff );
                div_to_render_scene[div_id]["4"].background = new THREE.Color( 0xffffff );
                div_to_render_scene[div_id]["5"].background = new THREE.Color( 0xffffff );
                div_to_render_scene[div_id]["6"].background = new THREE.Color( 0xffffff );

                // PLY file

                const loader = new PLYLoader();
                ["0","2", "3", "4", "5"].forEach(id => {
                    loader.load( mesh_path + id + ".ply", function ( geometry ) {
                        geometry.computeVertexNormals();
                        //let material = new THREE.MeshStandardMaterial( { color: 0xffffff} );
                        const material = new THREE.MeshPhongMaterial( {
                                                color: 0xCCE6FF,
                                                specular: 0x222222,
                                                shininess: 25,} );
                        const mesh_color = new THREE.Mesh( geometry, material );
                        div_to_render_scene[div_id][id].add( mesh_color );
                        //if (id === "0") {
                        //let material_geo = new THREE.MeshStandardMaterial( { color: 0x444444, flatShading: true } )
                        //const mesh_geo = new THREE.Mesh( geometry, material_geo );
                        //div_to_render_scene[div_id]["geo"].add( mesh_geo );
                        //}
                        //div_to_render_scene[div_id][id].add( new THREE.HemisphereLight( 0x333333, 0x222222 ) );
                        //addShadowedLight(div_to_render_scene[div_id][id], 1, 1, 1, 0xffffff, 1.35 );
                        //addShadowedLight(div_to_render_scene[div_id][id],  0.5, 1, - 1, 0xffffff, 1 );
                        add_lights(div_to_render_scene[div_id][id]);
                    }, (xhr) => {
                        console.log((xhr.loaded / xhr.total) * 100 + '% loaded')
                    }, (error) => {
                        console.log(error)
                    }
                    );
                })



                // renderer

                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( width, height);
                renderer.outputEncoding = THREE.sRGBEncoding;

                renderer.shadowMap.enabled = true;

                container.appendChild( renderer.domElement );

                controls = new OrbitControls(camera, renderer.domElement)
                controls.enableDamping = false

                // resize

                window.addEventListener( 'resize', onWindowResize );

        }
            function onWindowResize() {
                let width = container.clientWidth;
                let height = container.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize( width, height );
            }
            function animate() {
                requestAnimationFrame( animate );
                render();
            }

            function render() {
                let scene = div_to_render_scene[div_id][style_id]
                renderer.render( scene, camera );
                controls.update();
            }

            return controls;
        }

        function addShadowedLight(scene, x, y, z, color, intensity ) {

            const directionalLight = new THREE.DirectionalLight( color, intensity );
            directionalLight.position.set( x, y, z );
            scene.add( directionalLight );

            directionalLight.castShadow = true;

            const d = 1;
            directionalLight.shadow.camera.left = - d;
            directionalLight.shadow.camera.right = d;
            directionalLight.shadow.camera.top = d;
            directionalLight.shadow.camera.bottom = - d;

            directionalLight.shadow.camera.near = 1;
            directionalLight.shadow.camera.far = 4;

            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;

            directionalLight.shadow.bias = - 0.001;

        }

        document.addEventListener('keydown', logKey);

        function logKey(evt) {
            if (evt.keyCode === 71 && !mouse_button_down) {
                switch_geometry()
            }
            if (evt.keyCode === 82 && !mouse_button_down) {
                reset_orbit_controls()
            }
        }

        function switch_geometry() {
            render_colors = !render_colors
        }

        function reset_orbit_controls() {
            list_of_orbit_controls.forEach(oc => {
                oc.reset()
                oc.autoRotate = false
            })
        }

        function set_style_0(){
            style_id = "0"
        }

        function set_style_1(){
            style_id = "1"
        }

        function set_style_2(){
            style_id = "2"
        }

        function set_style_3(){
            style_id = "3"
        }

        function set_style_4(){
            style_id = "4"
        }
        function set_style_5(){
            style_id = "5"
        }
        function set_style_6(){
            style_id = "6"
        }

        document.body.onmousedown = function(evt) {
            if (evt.button === 0)
                mouse_button_down = true
        }
        document.body.onmouseup = function(evt) {
            if (evt.button === 0)
                mouse_button_down = false
        }

    </script>
</body>

</html>
